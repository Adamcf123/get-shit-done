---
phase: 01-core-enforcement-hook
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - hooks/gsd-enforce.js
autonomous: true

must_haves:
  truths:
    - "当 /gsd:plan-phase 回合结束时，如果没有 spawn gsd-planner，则 Stop 会 block 并给出清晰 remediation"
    - "当 /gsd:quick 回合结束时，如果没有 spawn gsd-executor，则 Stop 会 block"
    - "当命令声明 expected_artifacts 时，必须在同一回合内产生（按 mtime >= turn_start_ms 校验），否则 Stop block"
    - "产物扫描的根目录选择是确定性的：永远只扫描 repo/workspace 根（或等价确定路径），不会递归 HOME，也不会因环境差异而漂移"
    - "HOOK-05 的“validate completion”语义明确：SubagentStop 只记录“完成信号”用于增强错误信息/观测，不参与‘是否 spawn’与‘是否产物齐全’的判定（避免漏检与误判）"
  artifacts:
    - path: "hooks/gsd-enforce.js"
      provides: "Stop enforcement（block）+ artifact verification + SubagentStop completion tracking（辅助）"
  key_links:
    - from: "Stop"
      to: "decision=block"
      via: "hook output JSON"
      pattern: "\"decision\":\s*\"block\""
    - from: "artifact check"
      to: "filesystem"
      via: "mtime >= turn_start_ms"
      pattern: "turn_start"
    - from: "hooks/gsd-enforce.js"
      to: "artifact scan root"
      via: "deterministic repo root selection"
      pattern: "process\.cwd\(\)"
---

<objective>
把 Phase 1 的核心“强制执行”完成：Stop 事件对 required_subagent + expected_artifacts 做最终断言，不满足即阻止回合结束；同时用 SubagentStop（如果可用）记录 completion 作为辅助信号。

Purpose: 这一步让 ENF-01/ENF-03/ENF-04/HOOK-05 从“能记录”升级为“能阻止”，避免静默绕过。
Output: hooks/gsd-enforce.js 的 end-of-turn enforcement 与同回合产物校验。
</objective>

<execution_context>
@/home/adam/.claude/get-shit-done/workflows/execute-plan.md
@/home/adam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/01-core-enforcement-hook/01-CONTEXT.md
@.planning/phases/01-core-enforcement-hook/01-RESEARCH.md

@hooks/gsd-enforce.js
@重要命令.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stop 事件实现 required_subagent 断言（缺失即 block）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- Stop 事件：当 turn active 且 command 为 /gsd:*：
  - 从映射读取 required_subagent。
  - 若 required_subagent != none：
    - 若 delegated_subagent 缺失：decision=block。
    - 若 delegated_subagent 存在但不等于 required_subagent：decision=block（fail-closed，避免用 general-purpose 冒充）。
  - 若 required_subagent == none：不得 block。
- block reason 必须包含：命令名、期望 subagent、观察到的 delegated_subagent（若有）、以及“请使用 Task 工具委托到正确子代理”的指引。
- 成功路径：清理 turn state（避免污染后续回合）。
  </action>
  <verify>
- 合成输入：
  - /gsd:plan-phase 且 delegated_subagent 缺失 -> Stop 应 block。
  - /gsd:plan-phase 且 delegated_subagent=gsd-planner -> Stop 不应 block。
  - /gsd:quick 且 delegated_subagent=gsd-planner -> Stop 应 block。
  </verify>
  <done>
- ENF-01/ENF-03/ENF-04 的“缺委托就阻止”成立。
  </done>
</task>

<task type="auto">
  <name>Task 2: 同回合产物校验（expected_artifacts）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- 为映射表增加 expected_artifacts（Phase 1 先覆盖关键命令即可）：
  - /gsd:plan-phase：至少要求本回合产生 `.planning/phases/${PHASE}-*/*-PLAN.md`（更严格可要求 `${PHASE}-??-PLAN.md`），且 mtime >= turn_start_ms。
  - 其他命令可先设为 none（Phase 2 再完善）。
- Stop 事件在 subagent 校验通过后再做 artifact 校验：
  - 使用 deterministic 的文件匹配策略（不要依赖 shell glob 展开；node 内自己扫描目录 + 简单 pattern 匹配）。
  - 只认可“同回合新产物”：mtime >= turn_start_ms。
  - 缺失则 decision=block，并在 reason 中列出期望 pattern。
- 产物扫描根目录策略（必须确定且 fail-loud）：
  - scan_root 的确定顺序：
    1) stdin JSON 中若存在 workspace.current_dir（或等价字段）：用它。
    2) 否则使用 process.cwd()。
  - 约束：scan_root 必须是仓库根或其子目录；实现上至少保证只扫描 `path.join(scan_root, ".planning")`（或更小的 `.planning/phases`），不要递归扫描 scan_root 的所有文件，更不要扫描 os.homedir()。
  - 若 `.planning` 不存在：视为 UserFault（未按流程产生产物）并 block（reason 提示需要在仓库内运行或产生产物）。
  - 任何 path resolve/IO 异常：视为 SystemFault 并 fail-loud block（不得静默放行）。
  </action>
  <verify>
- “真实 Stop 输入”验证（解决 checker 要求的“real Stop input verification”）：
  1) 按 `@重要命令.txt` 执行 `npm run build:hooks && node bin/install.js --claude --global`，重启 Claude Code。
  2) 在本仓库里运行一次 `/gsd:plan-phase 1`，让 hook 收到真实 Stop 事件输入。
  3) 临时将真实 Stop stdin JSON（脱敏后）保存到 `os.tmpdir()/gsd-enforce/real-stop.json` 并在本地重放：`node hooks/gsd-enforce.js < real-stop.json`。
  4) 确认 artifact scan_root 选择与扫描范围符合预期（只触达 `.planning/...`），且缺产物会 block。
- 在一个临时目录里创建模拟产物并设置 mtime：
  - mtime < turn_start_ms -> 不应算成功
  - mtime >= turn_start_ms -> 应算成功
  </verify>
  <done>
- HOOK-05/Phase 决策“spawn + artifacts 两者都必须满足”落地；同回合产物校验生效；扫描范围确定且不会越界到 HOME。
  </done>
</task>

<task type="auto">
  <name>Task 3: SubagentStop 记录完成信号（辅助观测，非判定条件）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- 先明确语义（修复 HOOK-05 含糊）：
  - validate completion 的含义 = “记录子代理已结束（SubagentStop 收到）这一事实，作为 completion 信号，用于更好的错误信息与观测”。
  - completion 信号不用于判断“是否 spawn 了 required_subagent”（spawn 的事实来自 PreToolUse(Task) 的 delegated_subagent），也不用于判断“产物是否齐全”（产物由 expected_artifacts+mtime 校验）。
- SubagentStop 事件：读取 agent_id / agent_transcript_path（若存在），将 completed=true / completed_at_ms 写入 turn state。
- Stop 事件可以把 completed=true 作为 reason 的补充事实（例如：已完成子代理但产物缺失），但不得作为 allow/block 的分支条件。
  </action>
  <verify>
- 合成输入：SubagentStop 后，Stop 能读取 completed=true 并把它用于 reason（如果需要）。
- 反例验证：没有 SubagentStop 的情况下，只要 delegated_subagent + artifacts 满足，Stop 仍应 allow（不因缺 completion 信号误伤）。
  </verify>
  <done>
- HOOK-05 的语义被锁定：SubagentStop 只增强观测与错误信息，不影响正确性；避免“没 spawn 就没 SubagentStop 导致漏检”的 pitfall。
  </done>
</task>

</tasks>

<verification>
- ENF：Stop 必须能 block。
- Artifact：仅同回合产物计入成功；扫描根目录/范围确定，不越界到 HOME。
- HOOK-05：completion 信号不作为唯一依据，不参与是否 spawn 的判定。
</verification>

<success_criteria>
- /gsd:plan-phase 和 /gsd:quick 缺少正确 subagent 时会被阻止
- /gsd:plan-phase 若未在同回合生成映射声明的 PLAN 产物，会被阻止
- expected_artifacts 扫描根目录选择确定，且通过“真实 Stop 输入”验证
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-enforcement-hook/01-04-SUMMARY.md`
</output>
