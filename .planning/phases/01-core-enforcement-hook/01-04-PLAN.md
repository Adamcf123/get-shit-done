---
phase: 01-core-enforcement-hook
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - hooks/gsd-enforce.js
autonomous: true

must_haves:
  truths:
    - "当 /gsd:plan-phase 回合结束时，如果没有 spawn gsd-planner，则 Stop 会 block 并给出清晰 remediation"
    - "当 /gsd:quick 回合结束时，如果没有 spawn gsd-executor，则 Stop 会 block"
    - "当命令声明 expected_artifacts 时，必须在同一回合内产生（按 mtime >= turn_start_ms 校验），否则 Stop block"
  artifacts:
    - path: "hooks/gsd-enforce.js"
      provides: "Stop enforcement（block）+ artifact verification + SubagentStop completion tracking（可选）"
  key_links:
    - from: "Stop"
      to: "decision=block"
      via: "hook output JSON"
      pattern: "\"decision\":\s*\"block\""
    - from: "artifact check"
      to: "filesystem"
      via: "mtime >= turn_start_ms"
      pattern: "turn_start"
---

<objective>
把 Phase 1 的核心“强制执行”完成：Stop 事件对 required_subagent + expected_artifacts 做最终断言，不满足即阻止回合结束；同时用 SubagentStop（如果可用）记录 completion 作为辅助信号。

Purpose: 这一步让 ENF-01/ENF-03/ENF-04/HOOK-05 从“能记录”升级为“能阻止”，避免静默绕过。
Output: hooks/gsd-enforce.js 的 end-of-turn enforcement 与同回合产物校验。
</objective>

<execution_context>
@/home/adam/.claude/get-shit-done/workflows/execute-plan.md
@/home/adam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/01-core-enforcement-hook/01-CONTEXT.md
@.planning/phases/01-core-enforcement-hook/01-RESEARCH.md

@hooks/gsd-enforce.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stop 事件实现 required_subagent 断言（缺失即 block）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- Stop 事件：当 turn active 且 command 为 /gsd:*：
  - 从映射读取 required_subagent。
  - 若 required_subagent != none：
    - 若 delegated_subagent 缺失：decision=block。
    - 若 delegated_subagent 存在但不等于 required_subagent：decision=block（fail-closed，避免用 general-purpose 冒充）。
  - 若 required_subagent == none：不得 block。
- block reason 必须包含：命令名、期望 subagent、观察到的 delegated_subagent（若有）、以及“请使用 Task 工具委托到正确子代理”的指引。
- 成功路径：清理 turn state（避免污染后续回合）。
  </action>
  <verify>
- 合成输入：
  - /gsd:plan-phase 且 delegated_subagent 缺失 -> Stop 应 block。
  - /gsd:plan-phase 且 delegated_subagent=gsd-planner -> Stop 不应 block。
  - /gsd:quick 且 delegated_subagent=gsd-planner -> Stop 应 block。
  </verify>
  <done>
- ENF-01/ENF-03/ENF-04 的“缺委托就阻止”成立。
  </done>
</task>

<task type="auto">
  <name>Task 2: 同回合产物校验（expected_artifacts）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- 为映射表增加 expected_artifacts（Phase 1 先覆盖关键命令即可）：
  - /gsd:plan-phase：至少要求本回合产生 .planning/phases/${PHASE}-*/*-PLAN.md（或更严格：01-??-PLAN.md），并且 mtime >= turn_start_ms。
  - 其他命令可先设为 none（Phase 2 再完善）。
- Stop 事件在 subagent 校验通过后再做 artifact 校验：
  - 使用 deterministic 的文件匹配策略（不要依赖 shell glob 展开；node 内自己扫描目录 + 简单 pattern 匹配）。
  - 只认可“同回合新产物”：mtime >= turn_start_ms。
  - 缺失则 decision=block，并在 reason 中列出期望 pattern。
- 注意性能：扫描范围限定在 repo/workspace（例如从 workspace.current_dir 或 CWD 开始），避免递归整个 HOME。
  </action>
  <verify>
- 在一个临时目录里创建模拟产物并设置 mtime：
  - mtime < turn_start_ms -> 不应算成功
  - mtime >= turn_start_ms -> 应算成功
- 对 /gsd:plan-phase：当 artifacts 缺失时 Stop 应 block。
  </verify>
  <done>
- HOOK-05/Phase 决策“spawn + artifacts 两者都必须满足”落地；同回合产物校验生效。
  </done>
</task>

<task type="auto">
  <name>Task 3: SubagentStop 记录完成信号（辅助观测，非唯一依据）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- SubagentStop 事件：读取 agent_id / agent_transcript_path（若存在），将 completed=true / completed_at_ms 写入 turn state。
- 不把 SubagentStop 当成“是否 spawn”的唯一依据（避免 Pitfall 1），它只作为 completion 信号，用于更好的错误信息与后续调试。
  </action>
  <verify>
- 合成输入：SubagentStop 后，Stop 能读取 completed=true 并把它用于 reason（如果需要）。
  </verify>
  <done>
- SubagentStop 不影响正确性，但为后续错误分类与定位提供可靠信号。
  </done>
</task>

</tasks>

<verification>
- ENF：Stop 必须能 block。
- Artifact：仅同回合产物计入成功。
</verification>

<success_criteria>
- /gsd:plan-phase 和 /gsd:quick 缺少正确 subagent 时会被阻止
- /gsd:plan-phase 若未在同回合生成映射声明的 PLAN 产物，会被阻止
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-enforcement-hook/01-04-SUMMARY.md`
</output>
