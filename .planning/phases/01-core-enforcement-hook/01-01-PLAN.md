---
phase: 01-core-enforcement-hook
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/gsd-enforce.js
  - hooks/dist/gsd-enforce.js
  - scripts/build-hooks.js
  - bin/install.js
  - commands/gsd/plan-phase.md
  - commands/gsd/quick.md
autonomous: true

must_haves:
  truths:
    - "用户可以通过 ~/.claude/settings.json 全局安装 enforcement hook，并在 Claude Code 重启后仍生效"
    - "用户可以干净卸载 enforcement hook，不残留 hooks 注册与脚本文件"
  artifacts:
    - path: "hooks/gsd-enforce.js"
      provides: "enforcement hook 入口脚本（可被 hooks 系统调用）"
    - path: "hooks/dist/gsd-enforce.js"
      provides: "可安装的 dist hook 脚本（安装器从 dist 拷贝）"
    - path: "scripts/build-hooks.js"
      provides: "将 gsd-enforce.js 复制到 hooks/dist"
      contains: "gsd-enforce.js"
    - path: "bin/install.js"
      provides: "注册/卸载 hooks 到 settings.json（含 UserPromptSubmit/PreToolUse/SubagentStop/Stop）"
  key_links:
    - from: "scripts/build-hooks.js"
      to: "hooks/dist/gsd-enforce.js"
      via: "copy hook into dist"
      pattern: "gsd-enforce\\.js"
    - from: "bin/install.js"
      to: "~/.claude/settings.json"
      via: "settings.hooks registration"
      pattern: "settings\\.hooks"
---

<objective>
把“GSD 子代理强制执行”作为一个可安装/可卸载的 Claude Code hook 能力落地：新增 hook 脚本、纳入 dist 构建、并通过安装器写入/清理 settings.json。

Purpose: 先把交付物变成可运行的“基础设施”，后续计划只需填充检测与阻止逻辑。
Output: 新 hook 脚本 + dist 构建产物 + install/uninstall 注册逻辑 +（必要时）对 /gsd 命令文档的最小对齐。
</objective>

<execution_context>
@/home/adam/.claude/get-shit-done/workflows/execute-plan.md
@/home/adam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-core-enforcement-hook/01-CONTEXT.md
@.planning/phases/01-core-enforcement-hook/01-RESEARCH.md

@bin/install.js
@scripts/build-hooks.js
@hooks/gsd-statusline.js
@hooks/gsd-check-update.js
@commands/gsd/plan-phase.md
@commands/gsd/quick.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 新增可安装的 gsd-enforce hook 并纳入 hooks/dist 构建</name>
  <files>
hooks/gsd-enforce.js
scripts/build-hooks.js
hooks/dist/gsd-enforce.js
  </files>
  <action>
- 新增 hook 入口脚本（hooks/gsd-enforce.js）：先做最小可运行骨架即可（读取 stdin JSON；识别 hookEventName；默认允许/不阻止）。
- 明确实现“fail-loud 的框架入口”：如果解析 stdin JSON 失败或内部抛错，必须以 hooks 可理解的方式阻止（后续计划会统一错误格式，本计划先留 TODO 但要有可用的 error path）。
- 更新 hooks 构建脚本（scripts/build-hooks.js）：把 gsd-enforce.js 加入复制列表，确保 npm run build:hooks 后 hooks/dist/gsd-enforce.js 存在。
- 不要引入新的外部依赖；优先单文件实现，避免 dist 构建不复制目录导致安装缺文件。
  </action>
  <verify>
- npm run build:hooks
- test -f hooks/dist/gsd-enforce.js
- node hooks/gsd-enforce.js < /dev/null || true（确保脚本可执行，不因空输入崩溃）
  </verify>
  <done>
- hooks/dist/gsd-enforce.js 被构建产出；脚本可以被 node 执行；错误路径不会静默吞掉异常（至少有明确的非 0 退出或 stderr）。
  </done>
</task>

<task type="auto">
  <name>Task 2: 扩展安装器：注册/卸载 gsd-enforce hooks（覆盖四个事件）</name>
  <files>
bin/install.js
  </files>
  <action>
- 在安装逻辑中，向 Claude Code 的 settings.json 注册 gsd-enforce hook，覆盖事件：UserPromptSubmit、PreToolUse、SubagentStop、Stop。
- 注册方式遵循现有 patterns：不要破坏既有 SessionStart（gsd-check-update）；避免重复注册（幂等）。
- 兼容 global/local 安装：command 字符串使用已有 buildHookCommand 或相对路径方案，保证在两种安装位置都能找到 gsd-enforce.js。
- 卸载逻辑必须清理这些 hook 注册（不只 SessionStart），并删除安装目录内对应 hooks 文件（由安装器现有“删除 GSD hooks 文件”逻辑扩展）。
- 不在安装器里做 enforcement 业务逻辑；只做注册与清理。
  </action>
  <verify>
- npm run build:hooks
- node bin/install.js --claude --local
- cat .claude/settings.json | rg -n "gsd-enforce\\.js"（应出现 4 个事件下的 hook 注册）
- node bin/install.js --claude --local --uninstall
- test ! -f .claude/hooks/gsd-enforce.js || true（若 hooks 目录还存在，至少不应残留该文件）
- cat .claude/settings.json | rg -n "gsd-enforce\\.js" && exit 1 || true（卸载后不应残留注册）
  </verify>
  <done>
- HOOK-01/HOOK-02 的“安装/卸载基础设施”成立：注册可见、可重复执行、卸载后无残留。
  </done>
</task>

<task type="auto">
  <name>Task 3: 对齐命令文档中 subagent_type 的硬性约束（避免后续误判）</name>
  <files>
commands/gsd/plan-phase.md
commands/gsd/quick.md
  </files>
  <action>
- 以 ENF-03/ENF-04 为准：
  - /gsd:plan-phase 必须 spawn gsd-planner（Task subagent_type=gsd-planner）。
  - /gsd:quick 必须 spawn gsd-executor（Task subagent_type=gsd-executor）。
- 仅修改文档/示例 Task 调用的 subagent_type 与描述，使其与 hook 将要检查的字段一致；不要改变流程设计（本计划不改执行逻辑）。
- 保持中文沟通指令与现有 frontmatter 字段不变。
  </action>
  <verify>
- rg -n "subagent_type=\"gsd-planner\"" commands/gsd/plan-phase.md
- rg -n "subagent_type=\"gsd-executor\"" commands/gsd/quick.md
  </verify>
  <done>
- 文档层面的“预期 subagent 类型”与需求一致，降低 hook 实现时的歧义与误伤概率。
  </done>
</task>

</tasks>

<verification>
- HOOK-01/HOOK-02：安装/卸载在 local 模式至少可验证；global 模式在后续计划的人工验收里验证。
- 构建链路：npm run build:hooks 后 dist 中存在 gsd-enforce.js。
</verification>

<success_criteria>
- hooks/gsd-enforce.js 存在并可运行
- scripts/build-hooks.js 会生成 hooks/dist/gsd-enforce.js
- bin/install.js 能注册并卸载 4 个事件的 gsd-enforce hook
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-enforcement-hook/01-01-SUMMARY.md`
</output>
