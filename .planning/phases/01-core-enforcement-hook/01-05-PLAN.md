---
phase: 01-core-enforcement-hook
plan: 05
type: execute
wave: 5
depends_on: ["01-04"]
files_modified:
  - hooks/gsd-enforce.js
  - bin/install.js
autonomous: false

must_haves:
  truths:
    - "hook 内部任何错误都会 fail-loud（阻止回合结束），不会静默放行"
    - "被阻止时的提示语清晰说明：触发的命令、期望 subagent、观察到的事实、下一步如何用 Task 修复"
    - "hook 不会阻止非 /gsd:* 的正常使用（ERR-03）"
  artifacts:
    - path: "hooks/gsd-enforce.js"
      provides: "统一错误分类与阻止输出（Stop block / PreToolUse deny）"
    - path: "bin/install.js"
      provides: "确保安装后的 hook 超时/路径等配置合理（不引入不必要的阻塞）"
  key_links:
    - from: "internal error"
      to: "decision=block"
      via: "fail-loud policy"
      pattern: "ERR-01"
---

<objective>
把“阻止体验”和“错误策略”做成可维护的产品级输出：统一错误消息格式（标准密度），实现 fail-loud，并通过一次人工验收确认真实 Claude Code 环境下不误伤、能正确阻止。

Purpose: 没有清晰的 remediation，阻止只会让系统难用；没有 fail-loud，强制执行会被 silent failure 绕过。
Output: hooks/gsd-enforce.js 的错误处理与消息格式完善 + 人工验收步骤。
</objective>

<execution_context>
@/home/adam/.claude/get-shit-done/workflows/execute-plan.md
@/home/adam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/01-core-enforcement-hook/01-CONTEXT.md
@.planning/phases/01-core-enforcement-hook/01-RESEARCH.md

@hooks/gsd-enforce.js
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: 统一 fail-loud 错误处理与阻止消息（Stop block + PreToolUse deny）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- 统一错误分类：至少区分 UserFault vs SystemFault（满足 fail-loud 的可解释性）。
- 任何内部异常（JSON parse、状态文件损坏、IO 失败、字段缺失无法判定）必须走 fail-loud：
  - Stop：decision=block
  - PreToolUse：permissionDecision=deny（并提示这是 hook 内部错误，要求停止并修复/重试）
- 统一消息格式（标准密度）：
  - 标题：GSD enforcement blocked
  - 关键事实：command、required_subagent、delegated_subagent、expected_artifacts（如有）
  - 下一步：明确“使用 Task 工具委托到 {required_subagent}”
  - 若是 SystemFault：包含一个简短的错误码/分类，便于搜索定位
- 保证消息中不包含敏感内容（例如完整 prompt 或路径遍历信息）。
  </action>
  <verify>
- 构造破损 state 文件/无法写入目录等场景，确认会 block/deny（而不是放行或静默吞掉）。
- 构造正常非 /gsd 回合，确认不会 block。
  </verify>
  <done>
- ERR-01/ERR-02/ERR-03 成立：内部错必阻止、提示可操作、非 GSD 不误伤。
  </done>
</task>

<task type="auto">
  <name>Task 2: 确保安装配置的健壮性（timeout/重复注册/路径）</name>
  <files>bin/install.js</files>
  <action>
- 检查 install.js 写入 settings.json 的 hook 配置：
  - 对 gsd-enforce 的 4 个事件注册，确保不会重复插入多份。
  - 如需要 timeout：设置为一个合理值（例如 60s），并保持与现有示例一致。
  - command 路径必须在 global/local + custom config dir 组合下都正确。
- 卸载时确保清理所有事件中的 gsd-enforce 注册（不仅 SessionStart）。
  </action>
  <verify>
- 连续执行两次安装，settings.json 中不应出现重复 gsd-enforce 注册。
- 卸载后 settings.json 中不应残留 gsd-enforce。
  </verify>
  <done>
- 安装器行为幂等、可逆、可在不同安装模式下工作。
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GSD enforcement hook 在真实 Claude Code 中可触发、可阻止、且不误伤非 GSD</what-built>
  <how-to-verify>
1) 在本仓库执行安装：
   - `npm run build:hooks && node bin/install.js --claude --global`
2) 重启 Claude Code（确保 hooks 重新加载）。
3) 在任意项目里执行一个非 GSD 操作（例如普通提问或读取文件）：不应被阻止。
4) 执行 `/gsd:plan-phase 1`：
   - 如果主助手未立即用 Task spawn gsd-planner（或跳过产生计划产物），应该被阻止并看到 remediation。
5) 执行一次正确流程（主助手按要求 spawn 子代理并产生产物）：不应被阻止。
  </how-to-verify>
  <resume-signal>回复 "approved" 继续，或描述你看到的误伤/漏拦截现象</resume-signal>
</task>

</tasks>

<verification>
- 统一错误格式 + fail-loud
- 在真实 Claude Code 环境进行一次端到端验收
</verification>

<success_criteria>
- 内部错误必阻止（fail-loud）
- 阻止消息可操作（告诉下一步怎么用 Task 修复）
- 非 GSD 不误伤
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-enforcement-hook/01-05-SUMMARY.md`
</output>
