---
phase: 01-core-enforcement-hook
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - hooks/gsd-enforce.js
autonomous: true

must_haves:
  truths:
    - "在 /gsd:* 回合内，当 required_subagent 尚未被 Task spawn 时，任何不被允许的工具调用会被 PreToolUse 立即 deny"
    - "当 Task 被调用时，hook 能记录该次 Task 的 subagent_type（或等价字段）用于后续校验"
  artifacts:
    - path: "hooks/gsd-enforce.js"
      provides: "PreToolUse enforcement（deny）+ Task spawn tracking（delegated_subagent）"
  key_links:
    - from: "PreToolUse"
      to: "Task"
      via: "inspect tool_name + tool_input"
      pattern: "PreToolUse"
    - from: "PreToolUse deny"
      to: "permissionDecision"
      via: "hookSpecificOutput"
      pattern: "permissionDecision"
---

<objective>
把“委托前禁止乱用工具”的 fail-fast gate 做实：在 PreToolUse 阶段，当处于 GSD 回合且尚未 spawn 期望子代理时，立即 deny 非允许工具；同时捕获 Task 调用并记录 subagent_type。

Purpose: 防止主助手在委托前进行任何实质性工作（读文件、跑 bash、写文件等），从机制上逼迫其先走 subagent delegation。
Output: hooks/gsd-enforce.js 支持 PreToolUse 的 permissionDecision deny + Task spawn 记录。
</objective>

<execution_context>
@/home/adam/.claude/get-shit-done/workflows/execute-plan.md
@/home/adam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-core-enforcement-hook/01-CONTEXT.md
@.planning/phases/01-core-enforcement-hook/01-RESEARCH.md

@hooks/gsd-enforce.js
@commands/gsd/quick.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 实现 PreToolUse fail-fast gate（委托前 deny 非允许工具）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- 在 PreToolUse 事件中读取 tool_name（或等价字段）。
- 当 turn state 满足：active=true 且 command 为 /gsd:* 且尚未 delegated：
  - 仅允许 tool_name 属于“本命令映射声明的 allowed_pre_tools”（Phase 1 默认只允许 Task；对 /gsd:quick 如确需 AskUserQuestion，显式加入 allowed_pre_tools 并在 reason 中说明这是为了收集用户输入，避免误伤）。
  - 对不允许的工具：返回 hookSpecificOutput.permissionDecision="deny"，并给出 permissionDecisionReason（标准密度，指示“请先用 Task spawn {required_subagent}”）。
- 注意 hooks 约束：必须 exit code 0 且输出 JSON 才会生效；不要用 exit code 2。
- deny 的 reason 必须可操作：包含命令名、期望 subagent、以及“使用 Task 工具”的明确指引（不需要完整拷贝 Task 片段）。
  </action>
  <verify>
- 合成输入：
  - active 的 /gsd:plan-phase 回合里，PreToolUse(tool_name=Bash) 应 deny。
  - active 的 /gsd:plan-phase 回合里，PreToolUse(tool_name=Task) 应 allow。
- 在非 active 回合里，PreToolUse(tool_name=Bash) 不应 deny。
  </verify>
  <done>
- HOOK-04 的“PreToolUse 阶段可拦截并 deny”成立；ERR-03 的“非 GSD 不误伤”成立。
  </done>
</task>

<task type="auto">
  <name>Task 2: 捕获 Task 调用并记录 delegated subagent（用于后续 ENF 校验）</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
- 在 PreToolUse 事件中，当 tool_name==Task 且 turn active：
  - 解析 tool_input，提取 subagent_type（或等价字段）。
  - 把 delegated_subagent 写入 turn state（并记录 delegated_at_ms）。
- 不要做“软匹配/猜测”：字段缺失时按 fail-loud 策略处理（后续计划会统一错误分类与消息）。
- 记录只做事实，不做策略：是否匹配 required_subagent 的判断放到 Stop（本阶段先记录）。
  </action>
  <verify>
- 用真实 Claude Code 的 hooks debug 输出确认 Task 的 stdin JSON 结构（至少确认 subagent_type 的字段名）。
  - 若无法在当前环境直接跑 Claude Code，可先在 hook 内临时把 tool_input 的 keys 打到 stderr（脱敏），然后删除/降噪。
- 合成输入：PreToolUse(Task, tool_input.subagent_type="gsd-planner") 后，Stop 能读取到 delegated_subagent。
  </verify>
  <done>
- turn state 包含 delegated_subagent，且可跨事件读取。
  </done>
</task>

</tasks>

<verification>
- 关键验证：deny 发生在工具执行之前（PreToolUse），并且只在 active 且未 delegated 时触发。
</verification>

<success_criteria>
- /gsd:* 回合中，委托前的非允许工具被 deny
- Task 调用会被记录，为后续 ENF-01/ENF-03/ENF-04 提供依据
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-enforcement-hook/01-03-SUMMARY.md`
</output>
