---
phase: 02-advanced-detection-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/gsd-enforce.js
  - get-shit-done/templates/config.json
autonomous: true

must_haves:
  truths:
    - "Hook 从 .planning/config.json 读取 command_mapping 配置"
    - "配置文件不存在时回退到内置默认映射"
    - "配置格式无效时报错并回退到默认映射"
    - "未配置命令警告但不拦截"
  artifacts:
    - path: "hooks/gsd-enforce.js"
      provides: "loadCommandMapping() + getEffectiveCommandMap()"
      contains: "loadCommandMapping"
    - path: "get-shit-done/templates/config.json"
      provides: "command_mapping 字段模板"
      contains: "command_mapping"
  key_links:
    - from: "hooks/gsd-enforce.js:handleUserPromptSubmit"
      to: "loadCommandMapping()"
      via: "启动时加载配置"
      pattern: "loadCommandMapping"
    - from: "hooks/gsd-enforce.js:handleStop"
      to: "getEffectiveCommandMap()"
      via: "获取合并后的命令映射"
      pattern: "getEffectiveCommandMap"
---

<objective>
将 Phase 1 硬编码的 COMMAND_MAP 外置到项目级 .planning/config.json，使命令→子代理映射可维护。

Purpose: 满足 MAP-01/MAP-02 需求 — 用户可在项目配置中自定义命令映射，无需修改 hook 代码。
Output: loadCommandMapping() 函数 + 配置模板更新
</objective>

<execution_context>
@/home/adam/.claude/get-shit-done/workflows/execute-plan.md
@/home/adam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-advanced-detection-configuration/02-CONTEXT.md
@.planning/phases/02-advanced-detection-configuration/02-RESEARCH.md
@hooks/gsd-enforce.js
@get-shit-done/templates/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: 实现配置加载函数</name>
  <files>hooks/gsd-enforce.js</files>
  <action>
在 gsd-enforce.js 中添加配置加载逻辑：

1. 添加模块级变量缓存配置（无热重载，启动时加载一次）：
   ```javascript
   let projectCommandMapping = null;
   let configLoadError = null;
   ```

2. 实现 loadCommandMapping(workspaceDir) 函数：
   - 从 path.join(workspaceDir, '.planning', 'config.json') 读取
   - 解析 JSON 并提取 command_mapping 字段
   - 校验结构：每个 key 必须以 '/gsd:' 开头
   - 校验 required_subagent 必须是 string
   - 返回 { mapping, error }
   - 文件不存在时返回 { mapping: null, error: null }
   - 解析/校验失败时返回 { mapping: null, error: errorMessage }

3. 实现 getEffectiveCommandMap(projectMapping) 函数：
   - 如果 projectMapping 为 null，返回 DEFAULT_COMMAND_MAP
   - 否则返回 { ...DEFAULT_COMMAND_MAP, ...projectMapping }（项目配置覆盖默认）

4. 将现有 COMMAND_MAP 重命名为 DEFAULT_COMMAND_MAP 并添加 Object.freeze()

5. 在 handleUserPromptSubmit 开头加载配置（仅首次）：
   ```javascript
   if (projectCommandMapping === null && configLoadError === null) {
     const workspaceDir = getWorkspaceDir(data) || process.cwd();
     const result = loadCommandMapping(workspaceDir);
     projectCommandMapping = result.mapping;
     configLoadError = result.error;
     if (configLoadError) {
       debugLog(`config load error: ${configLoadError}`);
     }
   }
   ```

6. 修改 handleUserPromptSubmit 和 handleStop 中的 COMMAND_MAP 引用：
   - 改为调用 getEffectiveCommandMap(projectCommandMapping)
   - 未配置命令（不在 effective map 中）：输出 debugLog 警告但不拦截

注意：保持 Phase 1 的 fail-closed 语义 — 未映射的 /gsd:* 命令仍然在 Stop 时 block。
  </action>
  <verify>
GSD_ENFORCE_DEBUG=1 运行 hook 模拟脚本，确认：
- 无 .planning/config.json 时使用默认映射
- 有 config.json 但无 command_mapping 时使用默认映射
- 有 command_mapping 时合并覆盖默认映射
- 配置格式错误时输出 debug 警告并回退默认
  </verify>
  <done>
loadCommandMapping() 和 getEffectiveCommandMap() 函数存在且正确处理所有边界情况
  </done>
</task>

<task type="auto">
  <name>Task 2: 更新配置模板</name>
  <files>get-shit-done/templates/config.json</files>
  <action>
在 get-shit-done/templates/config.json 中添加 command_mapping 字段：

```json
{
  "mode": "interactive",
  "depth": "standard",
  ...existing fields...,
  "command_mapping": {
    "/gsd:plan-phase": {
      "required_subagent": "gsd-planner",
      "expected_artifacts": [
        {
          "base_dir": ".planning/phases",
          "required_any": ["**/*-PLAN.md"]
        }
      ],
      "allowed_pre_tools": ["Task"]
    },
    "/gsd:quick": {
      "required_subagent": "gsd-executor",
      "expected_artifacts": [
        {
          "base_dir": ".planning/quick",
          "required_all": ["**/*-PLAN.md", "**/*-SUMMARY.md"]
        }
      ],
      "allowed_pre_tools": ["AskUserQuestion", "Task"]
    },
    "/gsd:discuss-phase": {
      "required_subagent": "gsd-planner",
      "expected_artifacts": []
    }
  }
}
```

只包含最常用的 3 个命令作为示例，其他命令使用内置默认值。
  </action>
  <verify>
JSON 语法校验：node -e "require('./get-shit-done/templates/config.json')"
  </verify>
  <done>
config.json 模板包含 command_mapping 字段，格式正确
  </done>
</task>

</tasks>

<verification>
1. 配置加载测试：
   - 创建临时 .planning/config.json 带 command_mapping
   - 运行 hook 模拟，确认使用项目配置
   - 删除 config.json，确认回退默认

2. 边界情况测试：
   - 空 command_mapping: {}
   - 无效 key（不以 /gsd: 开头）
   - 无效 required_subagent（非 string）
</verification>

<success_criteria>
- [ ] loadCommandMapping() 函数存在且正确读取 .planning/config.json
- [ ] getEffectiveCommandMap() 正确合并项目配置和默认映射
- [ ] 配置文件不存在时静默回退默认
- [ ] 配置格式错误时 debug 警告并回退默认
- [ ] 模板 config.json 包含 command_mapping 示例
</success_criteria>

<output>
After completion, create `.planning/phases/02-advanced-detection-configuration/02-01-SUMMARY.md`
</output>
